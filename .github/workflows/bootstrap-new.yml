name: Bootstrap Terraform Backend (Unified)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to bootstrap (dr, stage, prod)'
        required: true
        type: choice
        options:
          - dr
          - stage
          - prod


permissions:
  id-token: write
  contents: write
  pull-requests: write
  actions: read

env:
  TF_VERSION: '1.5.0'
  AWS_REGION: 'us-east-1'
  role-session-name: "gh-bootstrap-${{ github.run_id }}"

jobs:
  create:
    if: ${{ vars.CREATE_BOOTSTRAP_ENABLED == 'true' }}
    name: Create Backend Infrastructure
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Code Checkout
        uses: actions/checkout@v4

      - name: Install Terraform Binary
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Assume AWS Role
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ github.event.inputs.environment == 'dr' && secrets.AWS_ROLE_ARN_DR || github.event.inputs.environment == 'stage' && secrets.AWS_ROLE_ARN_STAGE || secrets.AWS_ROLE_ARN_PROD }}
          role-session-name: ${{ env.role-session-name }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        working-directory: ./bootstrap
        run: terraform init

      - name: Terraform Plan
        working-directory: ./bootstrap
        run: |
          terraform plan \
            -var-file="terraform.tfvars.${{ github.event.inputs.environment }}" \
            -out=bootstrap-plan

      - name: Terraform Apply
        working-directory: ./bootstrap
        run: terraform apply -auto-approve bootstrap-plan

      - name: Upload Bootstrap State Artifact
        uses: actions/upload-artifact@v4
        with:
          name: bootstrap-state-${{ github.event.inputs.environment }}
          path: bootstrap/terraform.tfstate
          if-no-files-found: error
          retention-days: 14

      - name: Get Bootstrap Outputs
        working-directory: ./bootstrap
        id: outputs
        run: |
          BUCKET_NAME=$(terraform output -raw s3_bucket_name)
          DYNAMODB_TABLE=$(terraform output -raw dynamodb_table_name)
          echo "bucket_name=$BUCKET_NAME" >> $GITHUB_OUTPUT
          echo "dynamodb_table=$DYNAMODB_TABLE" >> $GITHUB_OUTPUT
          echo "### ðŸŽ‰ Bootstrap Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**S3 Bucket:** \`$BUCKET_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "**DynamoDB Table:** \`$DYNAMODB_TABLE\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Update \`backend-configs/${{ github.event.inputs.environment }}.hcl\` with bucket name: \`$BUCKET_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Commit and push the updated backend config" >> $GITHUB_STEP_SUMMARY
          echo "3. Your main CI/CD pipeline will now use remote state!" >> $GITHUB_STEP_SUMMARY

      - name: Update Backend Config File
        run: |
          cat > backend-configs/${{ github.event.inputs.environment }}.hcl << EOF
          bucket         = "${{ steps.outputs.outputs.bucket_name }}"
          key            = "${{ github.event.inputs.environment }}/terraform.tfstate"
          region         = "${{ env.AWS_REGION }}"
          dynamodb_table = "${{ steps.outputs.outputs.dynamodb_table }}"
          encrypt        = true
          EOF

      - name: Create Pull Request with Backend Config
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update backend config for ${{ github.event.inputs.environment }} environment"
          title: "Bootstrap: Update backend config for ${{ github.event.inputs.environment }}"
          body: |
            ## ðŸš€ Bootstrap Complete for ${{ github.event.inputs.environment }} Environment
            
            This PR updates the backend configuration with the newly created infrastructure:
            
            - **S3 Bucket:** `${{ steps.outputs.outputs.bucket_name }}`
            - **DynamoDB Table:** `${{ steps.outputs.outputs.dynamodb_table }}`
            
            ### What Changed:
            - Updated `backend-configs/${{ github.event.inputs.environment }}.hcl` with actual resource names
            
            ### Next Steps:
            1. Review and merge this PR
            2. Your main CI/CD pipeline will now use remote state storage
            3. Future Terraform operations will be stored in S3 with state locking
            
            **Auto-generated by Bootstrap workflow**
          branch: bootstrap/${{ github.event.inputs.environment }}-backend-config
          delete-branch: true
          add-paths: |
            backend-configs/${{ github.event.inputs.environment }}.hcl

      - name: Clear AWS Credentials
        if: always()
        run: |
          unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN

  destroy:
    needs: [create]
    if: ${{ vars.DESTROY_BOOTSTRAP_ENABLED == 'true' }}
    name: Destroy Backend Infrastructure
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Code Checkout
        uses: actions/checkout@v4

      - name: Install Terraform Binary
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Assume AWS Role
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ github.event.inputs.environment == 'dr' && secrets.AWS_ROLE_ARN_DR || github.event.inputs.environment == 'stage' && secrets.AWS_ROLE_ARN_STAGE || secrets.AWS_ROLE_ARN_PROD }}
          role-session-name: ${{ env.role-session-name }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download Bootstrap State Artifact
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: bootstrap-state-${{ github.event.inputs.environment }}
          path: bootstrap

      - name: Reconstruct State If Missing
        working-directory: ./bootstrap
        run: |
          if [ ! -f "terraform.tfstate" ]; then
            terraform init
            PROJECT_NAME=$(awk -F\" '/^project_name/ {print $2}' terraform.tfvars.${{ github.event.inputs.environment }})
            BUCKET_NAME="${PROJECT_NAME}-terraform-state-${{ github.event.inputs.environment }}"
            TABLE_NAME="${PROJECT_NAME}-terraform-locks-${{ github.event.inputs.environment }}"
            terraform import aws_s3_bucket.terraform_state "$BUCKET_NAME"
            terraform import aws_dynamodb_table.terraform_locks "$TABLE_NAME"
          fi

      - name: Terraform Destroy
        working-directory: ./bootstrap
        run: |
          terraform destroy \
            -var-file="terraform.tfvars.${{ github.event.inputs.environment }}" \
            -auto-approve

      - name: Clear AWS Credentials
        if: always()
        run: |
          unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN